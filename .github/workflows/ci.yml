name: ci

on:
  push:

jobs:
  lint_build_test:
    name: Lint, Build, and Test
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ballast-dev/timbre
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.BALLAST_DEV_TOKEN }}
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Setup Git
        run: |
          # Prevent ownership errors in container environments
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"
          
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions@github.com'
      

      - name: Test and Build
        run: |
          zig build test
          zig build all
      
      - uses: actions/upload-artifact@v4
        with:
          name: timbre
          path: |
            zig-out/aarch64-linux-musl
            zig-out/aarch64-macos
            zig-out/aarch64-windows
            zig-out/x86_64-linux-musl
            zig-out/x86_64-macos
            zig-out/x86_64-windows

      - name: Create release archives
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd zig-out
          tar -cJf timbre-aarch64-linux-musl.tar.xz aarch64-linux-musl
          tar -cJf timbre-aarch64-macos.tar.xz aarch64-macos
          tar -cJf timbre-aarch64-windows.tar.xz aarch64-windows
          tar -cJf timbre-x86_64-linux-musl.tar.xz x86_64-linux-musl
          tar -cJf timbre-x86_64-macos.tar.xz x86_64-macos
          tar -cJf timbre-x86_64-windows.tar.xz x86_64-windows

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} --title "${{ github.ref_name }}" --notes "Release ${{ github.ref_name }}" --generate-notes
          gh release upload ${{ github.ref_name }} zig-out/*.tar.xz